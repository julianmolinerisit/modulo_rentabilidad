<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Rentabilidad de Productos</title>
    <script>
        function calcularGanancia(idProducto) {
            // Obtener los elementos del DOM
            const rentabilidadInput = document.getElementById(`rentabilidad-${idProducto}`);
            const precioCompraText = document.getElementById(`precioCompra-${idProducto}`);
            const cantidadLoteInput = document.getElementById(`cantidadLote-${idProducto}`);
            const precioVentaText = document.getElementById(`precioVenta-${idProducto}`);
            const gananciaEsperadaText = document.getElementById(`gananciaEsperada-${idProducto}`);

            // Verificar que todos los elementos existen
            if (rentabilidadInput && precioCompraText && cantidadLoteInput && precioVentaText && gananciaEsperadaText) {
                // Obtener valores y convertir a números
                const porcentajeRentabilidad = parseFloat(rentabilidadInput.value) || 0;
                const precioCompra = parseFloat(precioCompraText.textContent) || 0;
                const cantidadLote = parseFloat(cantidadLoteInput.value) || 0;

                // Calcular precio de venta y ganancia esperada
                const precioVenta = precioCompra * (1 + porcentajeRentabilidad / 100);
                const gananciaEsperada = (precioVenta - precioCompra) * cantidadLote;

                // Mostrar resultados en el DOM
                precioVentaText.textContent = precioVenta.toFixed(2);
                gananciaEsperadaText.textContent = gananciaEsperada.toFixed(2);

                // Enviar datos al servidor para actualizar la base de datos
                actualizarBaseDeDatos(idProducto, precioVenta, gananciaEsperada, porcentajeRentabilidad);
            } else {
                console.error('Faltan algunos elementos necesarios para calcular la ganancia.');
            }
        }

        function actualizarBaseDeDatos(idProducto, precioVenta, gananciaEsperada, porcentajeRentabilidad) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", `/productos/${idProducto}/actualizar`, true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            
            const data = JSON.stringify({
                precioVenta: precioVenta,
                gananciaEsperada: gananciaEsperada,
                porcentajeRentabilidad: porcentajeRentabilidad
            });

            xhr.send(data);

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Datos actualizados correctamente.');
                } else {
                    console.error('Error al actualizar los datos.');
                }
            };
        }
    </script>
</head>
<body>
    <h1>Rentabilidad de Productos</h1>
    <p th:text="'Total de productos: ' + ${#lists.size(productos)}"></p>

    <table>
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Precio Compra</th>
                <th>Precio Venta</th>
                <th>Rentabilidad (%)</th>
                <th>Cantidad Lote</th>
                <th>Grasa Desperdicio (kg)</th>
                <th>Otros Desperdicios (kg)</th>
                <th>Ganancia Esperada</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="producto : ${productos}">
                <td th:text="${producto.nombre}">Nombre</td>
                <td th:text="${producto.categoria}">Categoría</td>
                <td th:id="'precioCompra-' + ${producto.id}" th:text="${producto.precioCompra}">0.00</td>
                <td th:id="'precioVenta-' + ${producto.id}" th:text="${producto.precioVenta}">0.00</td>
                <td>
                    <input type="number" th:id="'rentabilidad-' + ${producto.id}" th:value="${producto.porcentajeRentabilidad}" data-id="${producto.id}" />
                </td>
                <td>
                    <input type="number" th:id="'cantidadLote-' + ${producto.id}" value="1" data-id="${producto.id}" />
                </td>
                <td>
                    <input type="number" th:id="'grasaDesperdicio-' + ${producto.id}" value="0" data-id="${producto.id}" />
                </td>
                <td>
                    <input type="number" th:id="'otrosDesperdicios-' + ${producto.id}" value="0" data-id="${producto.id}" />
                </td>
                <!-- Ganancia esperada calculada dinámicamente -->
                <td th:id="'gananciaEsperada-' + ${producto.id}"  th:text="${producto.precioVenta - producto.precioCompra}">0.00</td>
                <td>
                    <button type="button" onclick="calcularGanancia('${producto.id}')">Calcular</button>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
